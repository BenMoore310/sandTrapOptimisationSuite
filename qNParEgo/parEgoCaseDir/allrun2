#!/usr/bin/env bash
set -euo pipefail

echo 'Running full particle tracking...'
cp system/controlDictKPF2 system/controlDict

# Start solver
mpirun -np 10 kinematicParcelFoam -parallel > log.KPF 2> >(grep -v "Authorization required, but no authorization protocol specified" | grep -v '^[[:space:]]*$' >&2) &
PID=$!
echo "Started solver PID=$PID"

threshold=5000
exitCode=0
IDLE_TIMEOUT=15   # 15 seconds of no log activity
lastActivity=$(date +%s)

# Monitor log until solver exits
while kill -0 "$PID" 2>/dev/null; do
    if read -t 1 -r line <&3; then
        lastActivity=$(date +%s)   # update activity timer
        if [[ "$line" == Courant* ]]; then
            maxVal=$(awk '{print $6}' <<< "$line")
            maxVal=${maxVal//max:/}
            if (( $(echo "$maxVal > $threshold" | bc -l) )); then
                echo "Courant number exceeded threshold: $maxVal"
                kill "$PID" 2>/dev/null || true
                exitCode=42
                break
            fi
        fi
    else
        now=$(date +%s)
        if (( now - lastActivity > IDLE_TIMEOUT )); then
            echo "No log activity for $IDLE_TIMEOUT seconds. Killing solver PID=$PID."
            kill "$PID" 2>/dev/null || true
            exitCode=43
            break
        fi
    fi
done 3< <(tail -n0 -f log.KPF)

# Wait for solver to finish, capture exit if it wasn't killed
wait "$PID" || true

# Report outcome
case $exitCode in
    0)  echo "Solver finished successfully" ;;
    42) echo "Solver stopped due to Courant number" ;;
    43) echo "Solver stopped due to inactivity timeout" ;;
esac

exit $exitCode

